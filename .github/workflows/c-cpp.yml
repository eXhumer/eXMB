name: Build and Upload eXMB
on:
  push:
    branches: [ qt6-cmake ]
  pull_request:
    branches: [ qt6-cmake ]
jobs:
  build-qt622-msvc2019_64:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Get Qt 6.2.2 Source Code
      run: |
        cd ..\
        git clone git://code.qt.io/qt/qt5.git qt622 --branch=6.2.2
        cd .\qt622
        perl init-repository --module-subset=qtbase,qtnetworkauth
    - name: Build Qt
      run: |
        $VSWHERE_PATH = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        $DEV_CMD_ARGS = "-arch=amd64", "-host_arch=amd64", "-no_logo"
        $MSVC2019_VSWHERE_INSTALL_PATH_ARGS = "-products", "*", "-requires", "Microsoft.VisualStudio.Component.VC.Tools.x86.x64", "-version", "[16.0,17.0)", "-property", "installationPath"
        $MSVC2019_INSTALL_PATH = & $VSWHERE_PATH $MSVC2019_VSWHERE_INSTALL_PATH_ARGS
        $MSVC2019_DEVSHELL_PATH = "$MSVC2019_INSTALL_PATH\Common7\Tools\Microsoft.VisualStudio.DevShell.dll"
        Import-Module $MSVC2019_DEVSHELL_PATH
        Enter-VsDevShell -VsInstallPath "$MSVC2019_INSTALL_PATH" -DevCmdArguments ($DEV_CMD_ARGS -join " ")
        mkdir ..\qt622-build
        cd ..\qt622-build
        ..\qt622\configure.bat -prefix ..\qt_622_msvc2019_64 -release -platform win32-msvc
        cmake --build . --parallel 2
        cmake --install .
    - name: Build eXMB
      run: |
        $VSWHERE_PATH = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        $DEV_CMD_ARGS = "-arch=amd64", "-host_arch=amd64", "-no_logo"
        $MSVC2019_VSWHERE_INSTALL_PATH_ARGS = "-products", "*", "-requires", "Microsoft.VisualStudio.Component.VC.Tools.x86.x64", "-version", "[16.0,17.0)", "-property", "installationPath"
        $MSVC2019_INSTALL_PATH = & $VSWHERE_PATH $MSVC2019_VSWHERE_INSTALL_PATH_ARGS
        $MSVC2019_DEVSHELL_PATH = "$MSVC2019_INSTALL_PATH\Common7\Tools\Microsoft.VisualStudio.DevShell.dll"
        Import-Module $MSVC2019_DEVSHELL_PATH
        Enter-VsDevShell -VsInstallPath "$MSVC2019_INSTALL_PATH" -DevCmdArguments ($DEV_CMD_ARGS -join " ")
        cmake -B build -S . -DCMAKE_PREFIX_PATH="..\qt_622_msvc2019_64" -CMAKE_INSTALL_PREFIX=out -DCMAKE_SYSTEM_VERSION="10.0.22000.0"
        cmake --build build --target eXMB --config Release --parallel 2
        cmake --install build
    - name: Upload build artifact
      uses: actions/upload-artifact@v2
      with:
        name: win32-qt622-msvc2019_64
        path: out/
